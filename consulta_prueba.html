<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consulta de Notas del Curso</title>
    <!-- Carga de Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- SIN RECAPTCHA: Esta versión es estable y funcional en GitHub Pages. -->
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary-blue': '#1e40af',
                        'success-green': '#10b981',
                        'failure-red': '#ef4444',
                        'bg-light': '#f9fafb',
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        /* Clase para animación de fade-in */
        .fade-in {
            animation: fadeIn 0.8s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        /* Estilo para los inputs */
        input:focus {
            outline: none;
            border-color: #1e40af;
            box-shadow: 0 0 0 3px rgba(30, 64, 175, 0.5); /* Sombra de foco azul */
        }

        /* Estilos del Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 50; /* Tailwind z-50 */
            opacity: 0;
            transition: opacity 0.3s ease-out;
            pointer-events: none;
        }
        .modal-overlay.active {
            opacity: 1;
            pointer-events: auto;
        }
        .modal-content {
            transform: scale(0.9);
            opacity: 0;
            transition: transform 0.3s ease-out, opacity 0.3s ease-out;
        }
        .modal-overlay.active .modal-content {
            transform: scale(1);
            opacity: 1;
        }
        
        /* Ocultar formulario, botones de acción y footer en la impresión */
        @media print {
            #consultForm, #actionButtons, footer {
                display: none;
            }
            #app-container {
                box-shadow: none;
                border: none;
                padding: 0;
            }
            body {
                background-color: white;
            }
            /* Asegurar que la tarjeta de resultados se vea bien al imprimir */
            #resultsContainer {
                opacity: 1 !important;
                pointer-events: auto !important;
                /* Eliminar colores de fondo fuertes para ahorrar tinta */
            }
            #summaryCard {
                box-shadow: none !important;
                background-color: white !important; /* Fondo blanco para imprimir */
                color: black !important;
                border: 1px solid #ccc;
            }
            #summaryCard * {
                color: black !important;
            }
            .bg-indigo-600, .bg-emerald-600, .bg-orange-600, .bg-rose-600 {
                background-color: #f0f0f0 !important;
                color: black !important;
            }
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center p-4">
    
    <!-- ENCABEZADO DEL SITIO (BANNER) -->
    <!-- Se eliminó el margen inferior (mb-4) para pegar el banner al contenedor principal -->
    <div class="w-full max-w-lg rounded-t-xl overflow-hidden shadow-xl">
        <img src="https://raw.githubusercontent.com/efajacsjlima/portal-servicios-academicos/refs/heads/main/bannerweb_consulta_notas_curso_gdp.png" 
             alt="Logo del Curso" 
             class="w-full h-auto object-cover" 
             onerror="this.onerror=null;this.src='https://placehold.co/600x120/9ca3af/ffffff?text=LOGO+NO+DISPONIBLE';" />
    </div>
    <!-- FIN ENCABEZADO DEL SITIO -->

    <!-- Modal de Recordatorio de Asistencia (INICIO) - Diseño Profesional -->
    <div id="reminderModal" class="modal-overlay">
        <div class="modal-content bg-white rounded-xl shadow-2xl max-w-sm w-11/12 p-6">
            <div class="flex flex-col items-center">
                <!-- Ícono de Advertencia / Información (más limpio que una imagen) -->
                <div class="bg-yellow-500 rounded-full p-3 mb-4">
                    <svg class="w-8 h-8 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.807-1.472 2.158-2.91L13.88 4.298c-.465-1.045-1.928-1.045-2.393 0L3.084 15.09c-.649 1.438.61 2.91 2.157 2.91z" />
                    </svg>
                </div>

                <h3 class="text-2xl font-bold text-gray-800 mb-2 text-center">
                    Recordatorio Importante
                </h3>
                
                <p class="text-sm text-gray-600 mb-6 text-center">
                    Ten en cuenta que la aprobación final del curso requiere cumplir con la **Nota Final aprobatoria** y el **90% de Asistencia** mínima.
                </p>

                <button id="closeModalBtn" class="w-full bg-primary-blue text-white font-semibold py-3 rounded-lg hover:bg-blue-700 transition duration-300 ease-in-out shadow-md">
                    Entendido, mostrar mis resultados
                </button>
            </div>
        </div>
    </div>
    <!-- Modal de Recordatorio de Asistencia (FIN) -->


    <!-- El contenedor principal ahora tiene rounded-b-xl para que se vea como una continuación del banner -->
    <div id="app-container" class="w-full max-w-lg bg-white shadow-2xl rounded-b-xl p-8 transition duration-500 ease-in-out">
        <header class="text-center mb-6">
            <h1 class="text-3xl font-extrabold text-gray-800">Consulta de Notas del Curso</h1>
            <p class="text-gray-500 mt-1">Identifícate con tu DNI para ver tus calificaciones.</p>
        </header>

        <!-- Formulario de Consulta (Vertical: Botón debajo del input) -->
        <form id="consultForm" class="flex flex-col gap-3">
            
            <input type="text" id="dniInput" placeholder="Ingresa tu DNI" 
                   class="p-3 border border-gray-300 rounded-lg focus:ring-primary-blue focus:border-primary-blue text-lg uppercase shadow-sm transition duration-150"
                   maxlength="15" required />
            
            <button type="submit" id="consultBtn" 
                    class="bg-primary-blue text-white font-semibold py-3 px-6 rounded-lg hover:bg-blue-700 transition duration-300 ease-in-out shadow-lg flex items-center justify-center disabled:opacity-50">
                <span id="buttonText">Consultar Notas</span>
                <div id="loadingSpinner" class="hidden w-5 h-5 border-2 border-t-2 border-white rounded-full animate-spin ml-2"></div>
            </button>
        </form>

        <!-- Contenedor de Mensajes (Errores/Éxito) -->
        <div id="messageContainer" class="mt-4 p-3 rounded-lg text-center font-medium hidden transition duration-300"></div>

        <!-- Contenedor de Resultados (Inicialmente oculto) -->
        <div id="resultsContainer" class="mt-6 space-y-6 opacity-0 pointer-events-none transition-opacity duration-500">
            
            <!-- DETALLE DE PRÁCTICAS (Grid 2x2 - FORMATO LLAMATIVO Y PULIDO) -->
            <div class="p-5 bg-bg-light rounded-xl shadow-xl border border-gray-200">
                <h2 class="text-xl font-extrabold text-gray-700 mb-5 text-center">
                    Puntuación por Práctica
                </h2>
                <!-- Grid 2x2 con colores y sombras fuertes -->
                <div class="grid grid-cols-2 gap-4 text-center">
                    <!-- Práctica 1 - Azul fuerte -->
                    <div class="p-4 bg-indigo-600 rounded-xl shadow-xl transition duration-300">
                        <p class="text-base text-white/90 font-medium flex items-center justify-center">
                            <svg class="w-4 h-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M11.049 2.21A1.5 1.5 0 0113.123 2.15l1.83 3.705a1.5 1.5 0 001.127.818l4.097.595a1.5 1.5 0 01.833 2.544l-2.964 2.895a1.5 1.5 0 00-.433 1.332l.707 4.088a1.5 1.5 0 01-2.17.814L12 18.067l-3.666 1.93a1.5 1.5 0 01-2.17-.814l.707-4.088a1.5 1.5 0 00-.433-1.332L2.09 7.858a1.5 1.5 0 01.833-2.544l4.097-.595a1.5 1.5 0 001.127-.818l1.83-3.705a1.5 1.5 0 012.074.056z" />
                            </svg>
                            Práctica 1
                        </p>
                        <p id="p1Score" class="text-5xl font-extrabold text-white mt-1"></p>
                    </div>
                    <!-- Práctica 2 - Verde fuerte -->
                    <div class="p-4 bg-emerald-600 rounded-xl shadow-xl transition duration-300">
                        <p class="text-base text-white/90 font-medium flex items-center justify-center">
                            <svg class="w-4 h-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M11.049 2.21A1.5 1.5 0 0113.123 2.15l1.83 3.705a1.5 1.5 0 001.127.818l4.097.595a1.5 1.5 0 01.833 2.544l-2.964 2.895a1.5 1.5 0 00-.433 1.332l.707 4.088a1.5 1.5 0 01-2.17.814L12 18.067l-3.666 1.93a1.5 1.5 0 01-2.17-.814l.707-4.088a1.5 1.5 0 00-.433-1.332L2.09 7.858a1.5 1.5 0 01.833-2.544l4.097-.595a1.5 1.5 0 001.127-.818l1.83-3.705a1.5 1.5 0 012.074.056z" />
                            </svg>
                            Práctica 2
                        </p>
                        <p id="p2Score" class="text-5xl font-extrabold text-white mt-1"></p>
                    </div>
                    <!-- Práctica 3 - Amarillo/Naranja fuerte -->
                    <div class="p-4 bg-orange-600 rounded-xl shadow-xl transition duration-300">
                        <p class="text-base text-white/90 font-medium flex items-center justify-center">
                            <svg class="w-4 h-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M11.049 2.21A1.5 1.5 0 0113.123 2.15l1.83 3.705a1.5 1.5 0 001.127.818l4.097.595a1.5 1.5 0 01.833 2.544l-2.964 2.895a1.5 1.5 0 00-.433 1.332l.707 4.088a1.5 1.5 0 01-2.17.814L12 18.067l-3.666 1.93a1.5 1.5 0 01-2.17-.814l.707-4.088a1.5 1.5 0 00-.433-1.332L2.09 7.858a1.5 1.5 0 01.833-2.544l4.097-.595a1.5 1.5 0 001.127-.818l1.83-3.705a1.5 1.5 0 012.074.056z" />
                            </svg>
                            Práctica 3
                        </p>
                        <p id="p3Score" class="text-5xl font-extrabold text-white mt-1"></p>
                    </div>
                    <!-- Práctica 4 - Rojo fuerte -->
                    <div class="p-4 bg-rose-600 rounded-xl shadow-xl transition duration-300">
                        <p class="text-base text-white/90 font-medium flex items-center justify-center">
                            <svg class="w-4 h-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M11.049 2.21A1.5 1.5 0 0113.123 2.15l1.83 3.705a1.5 1.5 0 001.127.818l4.097.595a1.5 1.5 0 01.833 2.544l-2.964 2.895a1.5 1.5 0 00-.433 1.332l.707 4.088a1.5 1.5 0 01-2.17.814L12 18.067l-3.666 1.93a1.5 1.5 0 01-2.17-.814l.707-4.088a1.5 1.5 0 00-.433-1.332L2.09 7.858a1.5 1.5 0 01.833-2.544l4.097-.595a1.5 1.5 0 001.127-.818l1.83-3.705a1.5 1.5 0 012.074.056z" />
                            </svg>
                            Práctica 4
                        </p>
                        <p id="p4Score" class="text-5xl font-extrabold text-white mt-1"></p>
                    </div>
                </div>
            </div>

            <!-- TARJETA ÚNICA DE RESUMEN (Nota Final con Icono de Trofeo) -->
            <div id="summaryCard" class="p-6 rounded-xl shadow-lg transition duration-300 ease-in-out text-center">
                <p id="studentNameDisplay" class="text-3xl font-bold text-white mb-2"></p>
                
                <!-- RECTÁNGULO DE DNI -->
                <div id="dniDisplayContainer" class="bg-white/30 rounded-lg p-2 inline-block mb-4">
                    <p id="dniDisplay" class="text-lg font-semibold text-white/90">
                        <!-- Contenido se llenará con JS -->
                    </p>
                </div>
                <!-- FIN RECTÁNGULO DE DNI -->
                
                <p class="font-semibold text-xl text-white mt-4 flex items-center justify-center">
                    <svg class="w-6 h-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    NOTA FINAL (Promedio Redondeado)
                </p>
                <p id="finalScore" class="text-8xl font-extrabold text-white mt-1"></p>
                <p id="finalStatus" class="text-xl font-medium text-white opacity-90 mt-2"></p>

                <div class="text-sm mt-4 pt-2 border-t border-white/30 text-white opacity-75">
                    <p id="secureConnection">Conexión segura vía Google Apps Script</p>
                    <p id="lastNoteConsult">Última consulta: Nunca</p>
                </div>
            </div>
            
            <!-- Botones de Acción: Imprimir y Correo -->
            <div id="actionButtons" class="hidden flex justify-center space-x-4 mt-6 print:hidden">
                <button id="printBtn" 
                        class="bg-gray-100 text-gray-700 font-semibold py-3 px-6 rounded-lg hover:bg-gray-200 transition duration-300 ease-in-out shadow-md flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2z" />
                    </svg>
                    Imprimir
                </button>
                
                <button id="mailBtn" 
                        class="bg-gray-100 text-gray-700 font-semibold py-3 px-6 rounded-lg hover:bg-gray-200 transition duration-300 ease-in-out shadow-md flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3 8l7.84 5.25A2 2 0 0013.16 13.25L21 8m-1 10a2 2 0 01-2 2H6a2 2 0 01-2-2V8a2 2 0 012-2h12a2 2 0 012 2v10z" />
                    </svg>
                    Enviar a Correo
                </button>
            </div>
            
        </div>
    </div>

    <script>
        // La URL debe ser reemplazada con tu URL real de Google Apps Script
        const APP_SCRIPT_URL = "https://script.google.com/macros/s/SU_APP_SCRIPT_ID/exec"; 
        
        // Simulación de datos de respuesta (Mock Data) para pruebas antes de conectar la API
        const mockData = {
            '12345678A': {
                Nombre: 'Carlos Gómez',
                Practica_1: 18, Practica_2: 17, Practica_3: 16, Practica_4: 18,
                Nota_Final: 17.25,
                Ultima_Consulta: new Date().toLocaleString(),
            },
            '98765432B': {
                Nombre: 'Ana López',
                Practica_1: 13, Practica_2: 14, Practica_3: 12, Practica_4: 13,
                Nota_Final: 13.00,
                Ultima_Consulta: new Date().toLocaleString(),
            },
            // DNI de prueba DESAPROBADO. Nota Final está VACÍA, el script la calculará (Simulación)
            '44445555C': {
                Nombre: 'Daniela Soto',
                Practica_1: 10, Practica_2: 11, Tercera_Practica: 10, Practica_4: 11,
                Nota_Final: NaN, // Simula celda vacía, el script debe calcular 10.50
                Ultima_Consulta: 'Nunca',
            }
        };

        const cache = {}; // Cache de sesión para evitar peticiones repetidas
        // Variables DOM sin inicializar al inicio, se inicializan en window.onload
        let FORM, INPUT, BTN, SPINNER, BTN_TEXT, MESSAGE_CONTAINER, RESULTS_CONTAINER, SUMMARY_CARD, REMINDER_MODAL, CLOSE_MODAL_BTN, APPROVAL_THRESHOLD, ACTION_BUTTONS, DNI_DISPLAY;
        let currentStudentName = ''; // Variable global para el correo

        // Función para simular un ID de Sesión de 20 dígitos
        function generateSessionId() {
            return Array.from({ length: 20 }, () => Math.floor(Math.random() * 10)).join('');
        }

        // Función que muestra el modal y espera a que el usuario presione 'Entendido'
        function showReminderModal() {
            return new Promise(resolve => {
                REMINDER_MODAL.classList.add('active');
                
                const handler = () => {
                    REMINDER_MODAL.classList.remove('active');
                    CLOSE_MODAL_BTN.removeEventListener('click', handler);
                    resolve();
                };

                CLOSE_MODAL_BTN.addEventListener('click', handler);
            });
        }

        // Función de utilidad para manejar reintentos y simular latencia
        async function exponentialBackoffFetch(url, options, retries = 3) {
            for (let i = 0; i < retries; i++) {
                try {
                    // Si estamos en modo mock (usando la URL de ejemplo), simular latencia
                    if (url.includes("SU_APP_SCRIPT_ID")) {
                        await new Promise(resolve => setTimeout(resolve, i === 0 ? 1500 : 500)); 
                    }
                    
                    const response = await fetch(url, options); // Se usa POST por el cálculo/escritura
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                } catch (error) {
                    console.error(`Fetch attempt ${i + 1} failed:`, error);
                    if (i === retries - 1) throw error;
                    // Espera exponencial antes de reintentar (1s, 2s, 4s...)
                    await new Promise(resolve => setTimeout(resolve, Math.pow(2, i) * 1000));
                }
            }
        }

        // Función de consulta
        async function fetchScores(dni) { // Eliminamos recaptchaToken
            // 1. Verificar Caché (no necesita token)
            if (cache[dni]) {
                const data = cache[dni];
                data.cached = true;
                return data;
            }

            // 2. Modo MOCK (Usando la URL de Ejemplo)
            if (APP_SCRIPT_URL.includes("SU_APP_SCRIPT_ID")) {
                const data = mockData[dni];
                if (data) return {...data, cached: false, dni: dni}; // Se añade el DNI al objeto de datos
                throw new Error("DNI no encontrado o error simulado.");
            }

            // 3. Modo REAL (Llamada al Google Apps Script via POST)
            const options = {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    dni: dni,
                }) 
            };

            const apiResponse = await exponentialBackoffFetch(APP_SCRIPT_URL, options);
            
            if (apiResponse.success) {
                // Almacenar en caché y devolver
                cache[dni] = apiResponse.data;
                return {...apiResponse.data, cached: false, dni: dni}; // Se añade el DNI al objeto de datos
            } else {
                // El script devolvió 'success: false'
                throw new Error(apiResponse.message || "No se pudo obtener la información.");
            }
        }

        function displayResults(data, isCached) {
            // 1. Preparar datos
            let rawFinalScore = data.Nota_Final; 

            // **SOLUCIÓN NaN PARA MOCK DATA:** Si es NaN (celda vacía simulada), calcular el promedio.
            if (isNaN(rawFinalScore)) {
                 rawFinalScore = (data.Practica_1 + data.Practica_2 + (data.Practica_3 || data.Tercera_Practica) + data.Practica_4) / 4;
            }

            const roundedFinalScore = Math.round(rawFinalScore); 
            const isApproved = rawFinalScore >= APPROVAL_THRESHOLD;
            currentStudentName = data.Nombre; // Guardar nombre para la función de correo
            
            // 2. Aplicar colores y mensaje
            const statusColor = isApproved ? 'bg-success-green' : 'bg-failure-red';
            
            // Lógica de mensaje: incluye "Sigue esforzándote"
            const statusText = isApproved 
                ? '¡Aprobado! Felicitaciones por tu esfuerzo.' 
                : 'Desaprobado. Sigue esforzándote.'; 
            
            // 3. Actualizar la Tarjeta de Resumen
            SUMMARY_CARD.className = `p-6 rounded-xl shadow-lg transition duration-300 ease-in-out ${statusColor}`;
            document.getElementById('studentNameDisplay').textContent = data.Nombre;
            
            // Llenar el nuevo contenedor de DNI
            DNI_DISPLAY.textContent = `DNI: ${data.dni || INPUT.value.toUpperCase()}`;
            
            document.getElementById('finalScore').textContent = roundedFinalScore;
            document.getElementById('finalStatus').textContent = `${statusText}`;
            
            // 4. Actualizar Timestamps
            const consultSource = isCached ? '(Caché)' : '(Sistema)';
            document.getElementById('lastNoteConsult').textContent = `Última consulta: ${data.Ultima_Consulta} ${consultSource}`;
            
            // 5. Actualizar Prácticas
            document.getElementById('p1Score').textContent = data.Practica_1;
            document.getElementById('p2Score').textContent = data.Practica_2;
            document.getElementById('p3Score').textContent = data.Practica_3 || data.Tercera_Practica; 
            document.getElementById('p4Score').textContent = data.Practica_4;
            
            // 6. Mostrar mensaje de éxito con el formato de Conexión Segura e ID de Sesión
            const sessionId = generateSessionId();
            showMessage(`Resultados de ${data.Nombre} cargados. Fuente: ${consultSource}`, 'success', sessionId);
            
            // 7. Mostrar contenedor de resultados y botones de acción con fade-in
            RESULTS_CONTAINER.classList.remove('opacity-0', 'pointer-events-none');
            RESULTS_CONTAINER.classList.add('fade-in');
            ACTION_BUTTONS.classList.remove('hidden');
        }

        function showMessage(msg, type = 'error', sessionId = null) {
            MESSAGE_CONTAINER.classList.remove('hidden', 'bg-red-100', 'text-red-700', 'bg-green-100', 'text-green-700', 'fade-in', 'border-l-4', 'border-green-500', 'border-red-500');
            
            let contentHTML = '';

            if (type === 'success') {
                // Estilo para el mensaje de éxito (SIN "Listo" y con espaciado ajustado)
                MESSAGE_CONTAINER.classList.add('bg-green-100', 'text-green-700', 'border-l-4', 'border-green-500', 'fade-in', 'text-left', 'py-3');
                
                contentHTML = `
                    <div class="text-left leading-tight">
                        <p class="text-base text-green-700 font-bold">Conexión segura establecida. ¡Bienvenido!</p>
                    </div>
                `;
                // Añadir el ID de Sesión
                if (sessionId) {
                    // Usamos mt-1 y ajustamos el tamaño de fuente para pegarlo más al texto superior
                    contentHTML += `<p class="text-xs text-gray-500 mt-1 text-left font-medium">Tu ID de Sesión: <span class="font-mono text-gray-800">${sessionId}</span></p>`;
                }

            } else {
                // Estilo para el mensaje de Error (Simple)
                MESSAGE_CONTAINER.classList.add('bg-red-100', 'text-red-700', 'border-l-4', 'border-red-500', 'fade-in', 'text-center');
                contentHTML = msg; 
            }
            MESSAGE_CONTAINER.innerHTML = contentHTML;
        }

        function resetUI() {
            RESULTS_CONTAINER.classList.add('opacity-0', 'pointer-events-none');
            RESULTS_CONTAINER.classList.remove('fade-in');
            MESSAGE_CONTAINER.classList.add('hidden');
            ACTION_BUTTONS.classList.add('hidden'); // Ocultar botones de acción al resetear
            document.getElementById('studentNameDisplay').textContent = '';
            DNI_DISPLAY.textContent = ''; // Limpiar el DNI
        }
        
        // Función principal que maneja el envío
        async function handleFormSubmit(e) {
            e.preventDefault(); // LÍNEA VITAL: Detiene la recarga de la página INMEDIATAMENTE

            const dni = INPUT.value.toUpperCase().trim();

            if (!dni) {
                showMessage("Por favor, ingresa tu DNI.", 'error');
                return;
            }
            
            resetUI();
            BTN.disabled = true;
            BTN_TEXT.textContent = 'Consultando Notas...';
            SPINNER.classList.remove('hidden');

            try {
                // 1. Obtener los datos del backend
                const data = await fetchScores(dni);
                
                // 2. Ocultar spinner y mostrar modal de recordatorio
                SPINNER.classList.add('hidden');
                BTN_TEXT.textContent = 'Consultar Notas';
                BTN.disabled = false;
                
                // 3. Mostrar el modal y esperar a que el usuario lo cierre
                await showReminderModal();
                
                // 4. Mostrar los resultados finales
                displayResults(data, data.cached);

            } catch (error) {
                console.error("Error en la consulta:", error);
                // Si hay error, el mensaje es simple y centrado
                showMessage(error.message || "Ocurrió un error en la consulta. Verifica tu conexión o inténtalo de nuevo.", 'error');
                BTN.disabled = false;
                BTN_TEXT.textContent = 'Consultar Notas';
                SPINNER.classList.add('hidden');
            }
        }


        // Asignación de variables DOM y Manejador de Eventos
        window.onload = () => {
            // Asignación de variables DOM
            FORM = document.getElementById('consultForm');
            INPUT = document.getElementById('dniInput');
            BTN = document.getElementById('consultBtn');
            SPINNER = document.getElementById('loadingSpinner');
            BTN_TEXT = document.getElementById('buttonText');
            MESSAGE_CONTAINER = document.getElementById('messageContainer');
            RESULTS_CONTAINER = document.getElementById('resultsContainer');
            SUMMARY_CARD = document.getElementById('summaryCard');
            REMINDER_MODAL = document.getElementById('reminderModal');
            CLOSE_MODAL_BTN = document.getElementById('closeModalBtn');
            ACTION_BUTTONS = document.getElementById('actionButtons'); // Nuevo
            DNI_DISPLAY = document.getElementById('dniDisplay'); // Nuevo DNI Display
            APPROVAL_THRESHOLD = 13; 
            
            // Adjuntamos el manejador de submit
            FORM.addEventListener('submit', handleFormSubmit);
            
            // Configurar los botones de acción
            document.getElementById('printBtn').addEventListener('click', () => {
                window.print();
            });
            document.getElementById('mailBtn').addEventListener('click', () => {
                const subject = encodeURIComponent(`Consulta de Notas Finales - ${currentStudentName}`);
                const body = encodeURIComponent(
                    `Adjunto puedes encontrar el documento PDF con mis resultados del curso. \n\n` + 
                    `También puedes consultar el resultado en línea en: ${window.location.href}\n\n` +
                    `Nota: Los resultados deben imprimirse (Ctrl+P o Cmd+P) antes de ser enviados.`
                );
                window.location.href = `mailto:?subject=${subject}&body=${body}`;
            });
        };
    </script>
</body>
</html>


